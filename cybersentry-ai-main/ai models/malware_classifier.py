import joblib
import numpy as np
from pathlib import Path
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import StandardScaler
import pandas as pd

class MalwareClassifier:
    """AI model for malware classification"""
    
    def __init__(self):
        self.model = None
        self.scaler = StandardScaler()
        self.model_path = Path("data/models/random_forest.pkl")
        self.load_model()
    
    def load_model(self):
        """Load trained model or create default"""
        if self.model_path.exists():
            self.model = joblib.load(self.model_path)
        else:
            # Create and train a simple model for demo
            self.model = RandomForestClassifier(
                n_estimators=100,
                max_depth=10,
                random_state=42
            )
            self.train_demo_model()
    
    def train_demo_model(self):
        """Train a demo model with synthetic data"""
        # Generate synthetic features for demo
        np.random.seed(42)
        n_samples = 2000
        
        # Simulated features: [file_size, entropy, sections, imports]
        X_benign = np.column_stack([
            np.random.normal(50000, 10000, n_samples//2),  # file_size
            np.random.uniform(4.0, 6.0, n_samples//2),         # entropy
            np.random.randint(3, 10, n_samples//2),         # sections
            np.random.randint(20, 100, n_samples//2)       # imports
        ])
        
        X_malicious = np.column_stack([
            np.random.normal(200000, 100000, n_samples//2),  # file_size
            np.random.uniform(6.5, 8.0, n_samples//2),           # entropy
            np.random.randint(1, 4, n_samples//2),           # sections
            np.random.randint(0, 5, n_samples//2)            # imports (often 0 for packed)
        ])
        
        X = np.vstack([X_benign, X_malicious])
        y = np.array([0]*(n_samples//2) + [1]*(n_samples//2))
        
        # Scale features
        X_scaled = self.scaler.fit_transform(X)
        
        # Train model
        self.model.fit(X_scaled, y)
        
        # Save model
        self.model_path.parent.mkdir(parents=True, exist_ok=True)
        joblib.dump(self.model, self.model_path)
        
        print(f"âœ… Demo AI model trained and saved to {self.model_path}")
    
    def predict(self, features):
        """Predict malware probability"""
        if self.model is None:
            return 0.5  # Default neutral prediction
        
        # Ensure features are in correct format
        features_array = np.array(features).reshape(1, -1)
        features_scaled = self.scaler.transform(features_array)
        
        try:
            probability = self.model.predict_proba(features_scaled)[0][1]
            return float(probability)
        except:
            return 0.5
    
    def get_feature_names(self):
        """Return feature names for explanation"""
        return ['file_size', 'entropy', 'sections', 'imports']